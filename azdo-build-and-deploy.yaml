trigger: 
- main

pool: 'ubuntu-latest'

variables:
  publisherId: 'jorge-codes'        
  extensionId: 'azure-backend-terraform-state-lock-waiter'        
  extensionName: 'Azure Backend Terraform State Lock Waiter'
  artifactName: 'vsix-artifact'
  visibility: 'private'
  marketplaceServiceConnection: 'd7744d61-b6a6-40d9-b5f7-ed766d9a9584'
  
stages:
  - stage: Test_and_validate
    displayName: 'Run Tests and Validate Code'
    jobs:
      - job: RunTests
        displayName: 'Execute tests'
        steps:
          - task: NodeTool@0
            displayName: Use Node (specified in .nvmrc file)
            inputs:
              versionSource: 'fromFile'
              versionFilePath: '.nvmrc'

          - task: AzureCLI@2
            displayName: 'Add test .env file'
            inputs:
              azureSubscription: DevOpsUserAccessAutomation (Dev/Test)
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                (az appconfig kv show  --name aztappconfig --key JORGE_AZDO_CUSTOM_TASK_EXTENSION_0_TEST_DOTENV | ConvertFrom-Json).value > ./tests/.env
                ls ./tests;
          
          - task: PowerShell@2
            displayName: 'Install dependencies and run tests (unit and integration)'
            inputs:
              targetType: 'inline'
              pwsh: true
              script: |
                npm ci;
                npm test;
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)'

  - stage: Package_extension
    displayName: 'Package Extension'
    dependsOn: Test_and_validate
    condition: succeeded()
    jobs:
      - job: PackageExtension
        displayName: 'Create VSIX package'
        steps:
          - task: TfxInstaller@4
            displayName: 'Install TFX CLI'
            inputs:
              version: "v0.x"

          - task: NodeTool@0
            displayName: Use Node (specified in .nvmrc file)
            inputs:
              versionSource: 'fromFile'
              versionFilePath: '.nvmrc'

          - task: PowerShell@2
            displayName: 'Build and package extension'
            inputs:
              targetType: 'inline'
              pwsh: true
              script: |
                npm run clean;
                npm run build;
                npm run package;

          - task: AzureCLI@2
            displayName: 'Set marketplace service connection auth token'
            inputs:
              azureSubscription: 'DevOpsUserAccessAutomation'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              useGlobalConfig: true
              inlineScript: |
                $accessToken = az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query "accessToken" --output tsv
                write-host "##vso[task.setsecret]$accessToken"
                write-host "##vso[task.setendpoint id=$env:MARKETPLACESERVICECONNECTION;field=authParameter;key=password]$accessToken"

          - task: QueryAzureDevOpsExtensionVersion@4
            name: QueryVersion
            displayName: 'Query current extension version'
            inputs:
              connectTo: 'VsTeam'
              connectedServiceName: '$(marketplaceServiceConnection)'
              publisherId: '$(publisherId)'
              extensionId: '$(extensionId)'
              versionAction: 'Patch'
          
          - task: PackageAzureDevOpsExtension@4
            displayName: 'Package extension'
            inputs:
              rootFolder: '$(System.DefaultWorkingDirectory)'
              publisherId: '$(publisherId)'
              extensionId: '$(extensionId)'
              extensionName: '$(extensionName)'
              extensionVersion: '$(QueryVersion.Extension.Version)'
              updateTasksVersion: true
              updateTasksVersionType: 'patch'
              extensionVisibility: '$(visibility)'
              extensionPricing: 'free'
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish VSIX artifact'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/*.vsix'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

  - stage: Publish_to_marketplace
    displayName: 'Publish to Marketplace'
    dependsOn: Package_extension
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: PublishExtension
        displayName: 'Deploy to marketplace'
        environment: 'marketplace-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  inputs:
                    azureSubscription: 'DevOpsUserAccessAutomation'
                    scriptType: 'pscore'
                    scriptLocation: 'inlineScript'
                    useGlobalConfig: true
                    inlineScript: |
                      $accessToken = az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query "accessToken" --output tsv
                      write-host "##vso[task.setsecret]$accessToken"
                      write-host "##vso[task.setendpoint id=$env:MARKETPLACESERVICECONNECTION;field=authParameter;key=password]$accessToken"
                      
                # - task: TfxInstaller@4
                #   displayName: 'Install TFX CLI'
                #   inputs:
                #     version: "v0.x"
                
                - task: PublishAzureDevOpsExtension@4
                  displayName: 'Publish to marketplace'
                  inputs:
                    connectTo: 'VsTeam'
                    connectedServiceName: '$(marketplaceServiceConnection)'
                    fileType: 'vsix'
                    vsixFile: '$(Pipeline.Workspace)/$(artifactName)/*.vsix'
                    publisherId: '$(publisherId)'
                    extensionId: '$(extensionId)'
                    extensionName: '$(extensionName)'
                    updateTasksVersion: false
                    extensionVisibility: '$(visibility)' 
                    extensionPricing: 'free'